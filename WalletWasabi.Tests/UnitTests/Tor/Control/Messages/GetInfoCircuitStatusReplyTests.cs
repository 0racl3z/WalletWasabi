using System.Text;
using System.Threading.Tasks;
using WalletWasabi.Tor.Control.Messages;
using Xunit;

namespace WalletWasabi.Tests.UnitTests.Tor.Control
{
	/// <summary>
	/// Tests for <see cref="GetInfoCircuitStatusReply"/> class.
	/// </summary>
	public class GetInfoCircuitStatusReplyTests
	{
		[Fact]
		public async Task ParseReplyAsync()
		{
			StringBuilder sb = new();
			sb.Append("250+circuit-status=\r\n");
			sb.Append("1 BUILT $E9F71AC06F29B2110E3FC09016B0E50407444EE2~libertas,$D0423D3A13C18D2ED0F3D5BFD90E13E77C9AD239~d0xkb,$3A9559477D72F71215850C97FA62A0DA7380964B~PawNetBlue BUILD_FLAGS=NEED_CAPACITY PURPOSE=GENERAL TIME_CREATED=2021-05-15T14:04:17.615384\r\n");
			sb.Append("2 BUILT $E9F71AC06F29B2110E3FC09016B0E50407444EE2~libertas,$A0FA50A070CFB4B89737A27F3259F92C118A0AF0~pipiska,$7E77CC94D94C08609D70B517FF938CC61C9F8232~pitfall BUILD_FLAGS=NEED_CAPACITY PURPOSE=GENERAL TIME_CREATED=2021-05-15T14:04:18.628885\r\n");
			sb.Append("3 BUILT $E9F71AC06F29B2110E3FC09016B0E50407444EE2~libertas,$706A7674A217BA905FE677E82236B7B968A23DB7~rofltor04,$4D4938B725B89561773A161215D88B7C45C43C35~TheGreenDynamo,$18CA339AD0C33EAB035F1D869518F3D2D88BABC0~FreeAssange BUILD_FLAGS=IS_INTERNAL,NEED_CAPACITY PURPOSE=HS_CLIENT_HSDIR HS_STATE=HSCI_CONNECTING TIME_CREATED=2021-05-15T14:04:19.353271\r\n");
			sb.Append("4 EXTENDED $E9F71AC06F29B2110E3FC09016B0E50407444EE2~libertas BUILD_FLAGS=IS_INTERNAL,NEED_CAPACITY PURPOSE=MEASURE_TIMEOUT TIME_CREATED=2021-05-15T14:04:19.631228\r\n");
			sb.Append("5 BUILT $E9F71AC06F29B2110E3FC09016B0E50407444EE2~libertas,$31D270A38505D4BFBBCABF717E9FB4BCA6DDF2FF~Belgium,$B411027C926A9BFFCF7DA91E3CAF1856A321EFFD~pulsetor BUILD_FLAGS=IS_INTERNAL,NEED_CAPACITY PURPOSE=HS_CLIENT_REND HS_STATE=HSCR_JOINED REND_QUERY=wasabiukrxmkdgve5kynjztuovbg43uxcbcxn6y2okcrsg7gb6jdmbad TIME_CREATED=2021-05-15T14:04:20.634686\r\n");
			sb.Append("6 BUILT $E9F71AC06F29B2110E3FC09016B0E50407444EE2~libertas,$573CC3D8F1C845AA33AA4593B68CA0D47156AA30~loglessRelay0,$F0F2CEF702D60AC53747CA6A7CA0C5C145F873F9~ax01 BUILD_FLAGS=IS_INTERNAL,NEED_CAPACITY PURPOSE=GENERAL TIME_CREATED=2021-05-15T14:04:21.649363\r\n");
			sb.Append("7 BUILT $E9F71AC06F29B2110E3FC09016B0E50407444EE2~libertas,$18ECBFC3A6834CB67414640C7F1E765E542CED2C~Unnamed,$708A968F3644F8A547156368FEA3DB664110E631~LittleFoxRahja,$81E18725397D620DA548ABBE24D9CD263DEF2FDC~rosskemp BUILD_FLAGS=IS_INTERNAL,NEED_CAPACITY PURPOSE=CIRCUIT_PADDING REND_QUERY=wasabiukrxmkdgve5kynjztuovbg43uxcbcxn6y2okcrsg7gb6jdmbad TIME_CREATED=2021-05-15T14:04:22.311493\r\n");
			sb.Append("8 BUILT $E9F71AC06F29B2110E3FC09016B0E50407444EE2~libertas,$2931AE89C9ED11361081D572F1174084CA8714CE~Hackhindi,$47E9EDA00A8A7BE0073501C3098EF9530771EB03~Unnamed BUILD_FLAGS=IS_INTERNAL,NEED_CAPACITY PURPOSE=GENERAL TIME_CREATED=2021-05-15T14:04:22.662664\r\n");
			sb.Append(".\r\n");

			string data = sb.ToString();

			TorControlReply rawReply = await TorControlReplyReaderTest.ParseAsync(data);
			GetInfoCircuitStatusReply reply = GetInfoCircuitStatusReply.FromReply(rawReply);

			Assert.Equal(8, reply.Circuits.Count);
		}		
	}
}
